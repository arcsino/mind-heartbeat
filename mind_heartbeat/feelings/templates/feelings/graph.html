{% extends "_shared/base.html" %}
{% load static %}
{% block title %}
  Feelings Graph - Mind Heartbeat
{% endblock title %}
{% block content %}
  <div class="max-w-2xl mx-auto bg-white border border-gray-200 rounded-xl shadow-lg p-8 mt-8">
    <h1 class="text-2xl font-bold mb-6 text-center">Feelings Score Over Time</h1>
    <canvas id="feelingsChart" class="w-full h-80"></canvas>
  </div>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
  const ctx = document.getElementById('feelingsChart').getContext('2d');
  const feelings = {{ feelings|safe }};
  const labels = feelings.map(f => f.created_at);
  const yValues = feelings.map(f => f.score);
  const names = feelings.map(f => f.name);
  const comments = feelings.map(f => f.comment);
  const stampImages = feelings.map(f => f.image);

  new Chart(ctx, {
  	type: 'line',
  	data: {
  		labels: labels,
  		datasets: [{
  			label: 'Feeling',
  			data: yValues,
  			borderColor: '#3b82f6',
  			backgroundColor: function(context) {
  				const chart = context.chart;
  				const {ctx, chartArea} = chart;
  				if (!chartArea) return null;
  				const gradient = ctx.createLinearGradient(0, chartArea.top, 0, chartArea.bottom);
  				gradient.addColorStop(0, 'rgba(59,130,246,0.3)');
  				gradient.addColorStop(1, 'rgba(59,130,246,0.01)');
  				return gradient;
  			},
  			tension: 0,
  			pointRadius: 4,
  			pointStyle: stampImages.map(imgUrl => {
  				const img = new Image();
  				img.src = imgUrl;
  				return img;
  			}),
  			pointBackgroundColor: '#3b82f6',
  			fill: true,
  		}]
  	},
  	options: {
  		responsive: true,
  		plugins: {
  			legend: { display: false },
  			tooltip: {
  				callbacks: {
  					title: function(context) {
  						const idx = context[0].dataIndex;
  						return names[idx] + '（スコア: ' + yValues[idx] + '）';
  					},
  					afterBody: function(context) {
  						const idx = context[0].dataIndex;
  						const comment = feelings[idx]?.comment || '';
  						return comment ? 'Comment: ' + comment : '';
  					}
  				}
  			}
  		},
  		scales: {
  			y: {
  				type: 'linear',
  				min: Math.min(...yValues) - 1,
  				max: Math.max(...yValues) + 1,
  				title: { display: true, text: 'Score' },
  				ticks: {
  					stepSize: 1
  				}
  			},
  			x: { title: { display: true, text: 'Time' } }
  		}
  	}
  });
  </script>
{% endblock content %}
