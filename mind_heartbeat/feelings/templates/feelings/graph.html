{% extends "_shared/base.html" %}
{% load static %}
{% block title %}
    Feelings Graph - Mind Heartbeat
{% endblock title %}
{% block content %}
    <div class="container-fluid min-vh-85 px-0">
        <div class="row gx-0">
            <div class="col-12 col-lg-6 mb-4 d-flex px-0">
                <div class="card shadow w-100 p-4 d-flex flex-column mx-3">
                    <h1 class="h2 fw-bold mb-4 text-center">感情スコアの推移</h1>
                    <canvas id="feelingsChart" class="max-h-520 w-100"></canvas>
                </div>
            </div>
            <div class="col-12 col-lg-6 mb-4 d-flex px-0">
                <div class="card shadow w-100 p-4 d-flex flex-column mx-3">
                    <h2 class="h4 fw-bold mb-4 text-center">心拍数の推移</h2>
                    <canvas id="heartrateChart" class="max-h-520 w-100"></canvas>
                </div>
            </div>
        </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
	// 感情グラフ
	const ctx = document.getElementById('feelingsChart').getContext('2d');
	const feelings = {{ feelings|safe }};
	const labels = feelings.map(f => f.created_at);
	const yValues = feelings.map(f => f.score);
	const names = feelings.map(f => f.name);
	const comments = feelings.map(f => f.comment);
	const stampImages = feelings.map(f => f.image);

	new Chart(ctx, {
		type: 'line',
		data: {
			labels: labels,
			datasets: [{
				label: 'Feeling',
				data: yValues,
				borderColor: '#3b82f6',
				backgroundColor: function(context) {
					const chart = context.chart;
					const {ctx, chartArea} = chart;
					if (!chartArea) return null;
					const gradient = ctx.createLinearGradient(0, chartArea.top, 0, chartArea.bottom);
					gradient.addColorStop(0, 'rgba(59,130,246,0.3)');
					gradient.addColorStop(1, 'rgba(59,130,246,0.01)');
					return gradient;
				},
				tension: 0,
				pointRadius: 4,
				pointStyle: stampImages.map(imgUrl => {
					const img = new Image();
					img.src = imgUrl;
					return img;
				}),
				pointBackgroundColor: '#3b82f6',
				fill: true,
			}]
		},
		options: {
			responsive: true,
			plugins: {
				legend: { display: false },
				tooltip: {
					callbacks: {
						title: function(context) {
							const idx = context[0].dataIndex;
							return names[idx] + '（スコア: ' + yValues[idx] + '）';
						},
						afterBody: function(context) {
							const idx = context[0].dataIndex;
							const comment = feelings[idx]?.comment || '';
							return comment ? 'Comment: ' + comment : '';
						}
					}
				}
			},
			scales: {
				y: {
					type: 'linear',
					min: Math.min(...yValues) - 1,
					max: Math.max(...yValues) + 1,
					title: { display: true, text: 'Score' },
					ticks: {
						stepSize: 1
					}
				},
				x: { title: { display: true, text: 'Time' } }
			}
		}
	});

	// 心拍数グラフ
	const heartrateCtx = document.getElementById('heartrateChart').getContext('2d');
	const heartrates = {{ heartrates|safe }};
	const hrLabels = heartrates.map(h => h.timestamp);
	const hrValues = heartrates.map(h => h.bpm);
	new Chart(heartrateCtx, {
		type: 'line',
		data: {
			labels: hrLabels,
			datasets: [{
				label: 'Heart Rate',
				data: hrValues,
				borderColor: '#ef4444',
				backgroundColor: 'rgba(239,68,68,0.1)',
				tension: 0.2,
				pointRadius: 3,
				pointBackgroundColor: '#ef4444',
				fill: true,
			}]
		},
		options: {
			responsive: true,
			plugins: {
				legend: { display: false },
				tooltip: {
					callbacks: {
						title: function(context) {
							const idx = context[0].dataIndex;
							return hrLabels[idx] + '（BPM: ' + hrValues[idx] + '）';
						}
					}
				}
			},
			scales: {
				y: {
					type: 'linear',
					min: Math.min(...hrValues, 40) - 5,
					max: Math.max(...hrValues, 120) + 5,
					title: { display: true, text: 'BPM' },
				},
				x: { title: { display: true, text: 'Time' } }
			}
		}
	});
    </script>
{% endblock content %}
